{% extends "base.html" %}

{% block content %}
<section class="h-full p-8 space-y-4">
    <article class="bg-white rounded-lg shadow-sm p-8">
        <header class="text-2xl font-bold text-gray-800 mb-6">Worker Clock Events</header>
        <div class="flex items-center justify-between">
            <time id="clock" class="text-4xl font-mono font-bold text-gray-800 bg-gray-50 px-8 py-4 rounded-lg shadow-inner">--:--:--</time>
            <aside id="status" class="text-sm font-medium rounded-full px-4 py-1"></aside>
        </div>
    </article>

    <article class="bg-white rounded-lg shadow-sm p-8">
        <header class="text-lg font-semibold text-gray-800 mb-4">Debug Log</header>
        <section id="messages" class="font-mono text-sm bg-gray-50 rounded-lg p-4 h-[200px] overflow-y-auto space-y-1">
        </section>
    </article>

    <script>
        const messagesDiv = document.getElementById('messages');
        const statusDiv = document.getElementById('status');
        const clockDiv = document.getElementById('clock');
        let ws = null;
        let clientId = localStorage.getItem('websocket_client_id');
        let reconnectTimer = null;
        let isReconnecting = false;
        
        function cleanupConnection() {
            if (ws) {
                try {
                    ws.close();
                } catch (e) {
                    console.log('Error closing WebSocket:', e);
                }
                ws = null;
            }
            if (reconnectTimer) {
                clearTimeout(reconnectTimer);
                reconnectTimer = null;
            }
        }

        function scheduleReconnect(delay = 1000) {
            if (!isReconnecting && !reconnectTimer) {
                isReconnecting = true;
                reconnectTimer = setTimeout(() => {
                    reconnectTimer = null;
                    isReconnecting = false;
                    if (!ws) connect();
                }, delay);
            }
        }
        
        function connect() {
            cleanupConnection();

            try {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const url = `${protocol}//${window.location.host}/websocket_do${clientId ? '?id=' + clientId : ''}`;
                ws = new WebSocket(url);
                
                ws.onopen = () => {
                    statusDiv.textContent = 'Connected';
                    statusDiv.className = 'text-sm font-medium rounded-full px-4 py-1 bg-green-100 text-green-800';
                    console.log('WebSocket connected');
                    isReconnecting = false;
                };
                
                ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        console.log('Received message:', data);
                        
                        if (data.type === 'client_id') {
                            clientId = data.id;
                            localStorage.setItem('websocket_client_id', clientId);
                            return;
                        }

                        if (data.type === 'ping') {
                            console.log('Ping received from server');
                            return;
                        }
                        
                        if (data.type === 'timestamp') {
                            const date = new Date(parseInt(data.timestamp));
                            const time = date.toLocaleTimeString();
                            clockDiv.textContent = time;
                            
                            const messageDiv = document.createElement('div');
                            messageDiv.className = 'text-gray-600';
                            messageDiv.textContent = `${time} - Timestamp received`;
                            messagesDiv.appendChild(messageDiv);
                            messagesDiv.scrollTop = messagesDiv.scrollHeight;
                        }
                    } catch (error) {
                        console.error('Error processing message:', error, event.data);
                    }
                };
                
                ws.onclose = (event) => {
                    console.log('WebSocket closed:', event.code, event.reason);
                    statusDiv.textContent = 'Disconnected - Reconnecting...';
                    statusDiv.className = 'text-sm font-medium rounded-full px-4 py-1 bg-red-100 text-red-800';
                    ws = null;

                    if (event.code !== 1000) {
                        scheduleReconnect();
                    }
                };

                ws.onerror = (error) => {
                    console.log('WebSocket error:', error);
                };
            } catch (error) {
                console.error('Error creating WebSocket:', error);
                scheduleReconnect();
            }
        }
        
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                cleanupConnection();
            } else {
                if (!ws && !isReconnecting) {
                    connect();
                }
            }
        });

        window.addEventListener('beforeunload', () => {
            cleanupConnection();
        });
        
        connect();
    </script>
</section>
{% endblock %} 