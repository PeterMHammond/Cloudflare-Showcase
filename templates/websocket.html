{% extends "base.html" %}

{% block content %}
<script>
htmx.defineExtension('time-converter', {
    transformResponse: function(text, xhr, elt) {
        try {
            // Try to find timestamp in the HTML response
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = text;
            
            // Find elements with data-utc attribute
            const timeElements = tempDiv.querySelectorAll('[data-utc]');
            timeElements.forEach(el => {
                const utcTime = el.getAttribute('data-utc');
                const localTime = new Date(parseInt(utcTime)).toLocaleTimeString();
                el.textContent = localTime;
            });
            
            return tempDiv.innerHTML;
        } catch (e) {
            console.error('Error converting time:', e);
            return text;
        }
    }
});

htmx.defineExtension('ws-debug', {
    onEvent: function(name, evt) {
        function formatMessage(msg) {
            if (typeof msg === 'string') {
                return msg
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#039;')
                    .replace(/\n/g, '<br>')
                    .replace(/\s/g, '&nbsp;');
            } else {
                return JSON.stringify(msg, null, 2);
            }
        }

        if (name === "htmx:wsBeforeMessage") {
            const logDiv = document.getElementById('message-log');
            if (logDiv) {
                const message = evt.detail.message;
                const timestamp = new Date().toLocaleTimeString();
                const debugEntry = document.createElement('div');
                debugEntry.className = 'text-blue-400 whitespace-pre';
                debugEntry.innerHTML = `[${timestamp}] Raw Message Received:<br>${formatMessage(message)}`;

                // Also log the parsed message if it's JSON
                try {
                    if (typeof message === 'string') {
                        const parsed = JSON.parse(message);
                        const parsedEntry = document.createElement('div');
                        parsedEntry.className = 'text-blue-200 whitespace-pre pl-4 text-xs';
                        parsedEntry.innerHTML = `Parsed as:<br>${JSON.stringify(parsed, null, 2)}`;
                        debugEntry.appendChild(parsedEntry);
                    }
                } catch (e) {
                    // Not JSON, ignore
                }

                logDiv.appendChild(debugEntry);
                logDiv.scrollTop = logDiv.scrollHeight;
            }
        }
        if (name === "htmx:wsBeforeSend") {
            const logDiv = document.getElementById('message-log');
            if (logDiv) {
                const message = evt.detail.message;
                const timestamp = new Date().toLocaleTimeString();
                const debugEntry = document.createElement('div');
                debugEntry.className = 'text-yellow-400 whitespace-pre';
                debugEntry.innerHTML = `[${timestamp}] Raw Message Sent:<br>${formatMessage(message)}`;

                // Also log the parsed message if it's JSON
                try {
                    if (typeof message === 'string') {
                        const parsed = JSON.parse(message);
                        const parsedEntry = document.createElement('div');
                        parsedEntry.className = 'text-yellow-200 whitespace-pre pl-4 text-xs';
                        parsedEntry.innerHTML = `Parsed as:<br>${JSON.stringify(parsed, null, 2)}`;
                        debugEntry.appendChild(parsedEntry);
                    }
                } catch (e) {
                    // Not JSON, ignore
                }

                logDiv.appendChild(debugEntry);
                logDiv.scrollTop = logDiv.scrollHeight;
            }
        }
    }
});
</script>

<section class="h-full p-8 flex flex-col overflow-hidden" 
         hx-ext="ws,time-converter,ws-debug" 
         ws-connect="/websocket_do">
    <article class="bg-white rounded-lg shadow-sm p-8 space-y-4 flex-none">
        <header class="text-2xl font-bold text-gray-800">Websocket Events Example</header>
        <aside id="connection-status" 
               class="inline-block text-sm font-medium rounded-full px-4 py-1"
               ws-connected="this.classList.add('bg-green-100', 'text-green-600'); this.textContent='Connected'"
               ws-disconnected="this.classList.remove('bg-green-100', 'text-green-600'); this.classList.add('bg-red-100', 'text-red-600'); this.textContent='Disconnected'">
            Connecting...
        </aside>
        <section class="flex items-start space-x-4">
            <time class="inline-block text-gray-800 bg-gray-50 px-8 py-4 rounded-lg shadow-inner h-[100px] flex flex-col items-center justify-center">
                <header class="font-semibold text-sm">Clock Event</header>
                <p id="clock-display" 
                   class="text-4xl font-bold">--:--:--</p>
            </time>
            
            <section class="inline-block bg-gray-50 px-8 py-4 rounded-lg shadow-inner text-gray-800 h-[100px] flex flex-col items-center justify-center">
                <header class="font-semibold text-sm">Connected Clients</header>
                <p id="client-count" 
                   class="text-4xl font-bold">0</p>
            </section>
            
            <section class="inline-block bg-gray-50 px-8 py-4 rounded-lg shadow-inner text-gray-800 h-[100px] flex flex-col items-center justify-center">
                <header class="font-semibold text-sm">Shared Checkbox</header>
                <div id="shared-checkbox-container">
                    <form ws-send hx-trigger="change from:input">
                        <label class="flex items-center space-x-2 mt-2">
                            <input type="checkbox" 
                                   id="shared-checkbox"
                                   name="checkbox-state"
                                   class="w-6 h-6 rounded">
                        </label>
                    </form>
                </div>
            </section>
            
            <section class="inline-block bg-gray-50 px-8 py-4 rounded-lg shadow-inner text-gray-800 h-[100px] flex flex-col items-center justify-center">
                <header class="font-semibold text-sm">Shared Input</header>
                <form ws-send>
                    <input type="text" 
                           id="shared-input"
                           name="input-text"
                           class="mt-2 px-4 py-2 border rounded-lg text-lg text-center" 
                           placeholder="Type here..."
                           hx-trigger="keyup changed delay:200ms">
                </form>
            </section>
        </section>
    </article>

    <article class="flex-1 bg-white rounded-lg shadow-sm p-8 mt-4 flex flex-col overflow-hidden">
        <header class="text-lg font-semibold text-gray-800 mb-4 flex-none">Debug Log</header>
        <section id="message-log" 
                 class="flex-1 min-h-0 max-h-[300px] font-mono text-sm bg-black text-green-500 rounded-lg p-4 overflow-y-auto space-y-1">
        </section>
    </article>
</section>
{% endblock %}
