{% extends "base.html" %}

{% block content %}
<section class="h-full p-8 space-y-4">
    <article class="bg-white rounded-lg shadow-sm p-8 space-y-4">
        <header class="text-2xl font-bold text-gray-800">Worker Clock Events</header>
        <aside id="status" class="inline-block text-sm font-medium rounded-full px-4 py-1 text-green-600 bg-green-100">
            Connected
        </aside>
        <section class="flex items-start space-x-4">
            <time id="clock" class="inline-block text-4xl font-mono font-bold text-gray-800 bg-gray-50 px-8 py-4 rounded-lg shadow-inner">
                --:--:--
            </time>
            <section id="additional-info" class="inline-block bg-gray-50 px-6 py-4 rounded-lg shadow-inner text-gray-800">
                <header class="font-semibold text-sm">Additional Info</header>
                <p class="text-xs">More details about the clock here...</p>
            </section>
        </section>
    </article>
    
    <article class="bg-white rounded-lg shadow-sm p-8">
        <header class="text-lg font-semibold text-gray-800 mb-4">Debug Log</header>
        <section id="messages" class="font-mono text-sm bg-black text-green-500 rounded-lg p-4 h-[200px] overflow-y-auto">
            <!-- Logs will be dynamically appended here -->
        </section>
    </article>
    <script>
        const messagesDiv = document.getElementById('messages');
        const statusDiv = document.getElementById('status');
        const clockDiv = document.getElementById('clock');
        let ws = null;
        let clientId = localStorage.getItem('websocket_client_id');
        let reconnectTimer = null;
        let isReconnecting = false;
        
        function cleanupConnection() {
            if (ws) {
                try {
                    ws.close();
                } catch (e) {
                    console.log('Error closing WebSocket:', e);
                }
                ws = null;
            }
            if (reconnectTimer) {
                clearTimeout(reconnectTimer);
                reconnectTimer = null;
            }
        }

        function scheduleReconnect(delay = 1000) {
            if (!isReconnecting && !reconnectTimer) {
                isReconnecting = true;
                reconnectTimer = setTimeout(() => {
                    reconnectTimer = null;
                    isReconnecting = false;
                    if (!ws) connect();
                }, delay);
            }
        }
        
        function connect() {
            cleanupConnection();

            try {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const url = `${protocol}//${window.location.host}/websocket_do${clientId ? '?id=' + clientId : ''}`;
                ws = new WebSocket(url);
                
                ws.onopen = () => {
                    statusDiv.textContent = 'Connected';
                    statusDiv.className = 'inline-block text-sm font-medium rounded-full px-4 py-1 bg-green-100 text-green-800';
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'text-yellow-500';
                    messageDiv.textContent = `[${new Date().toLocaleTimeString()}] 🔌 WebSocket connected`;
                    messagesDiv.appendChild(messageDiv);
                    isReconnecting = false;
                };
                
                ws.onmessage = (event) => {
    try {
        const data = JSON.parse(event.data);
        console.log('Received message:', data);
        
        const date = new Date();
        const time = date.toLocaleTimeString();
        const messageDiv = document.createElement('div');
        messageDiv.className = 'text-green-500';
        messageDiv.textContent = `[${time}] ⬇️ Received: ${JSON.stringify(data)}`;
        messagesDiv.appendChild(messageDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
        
        if (data.type === 'client_id') {
            clientId = data.id;
            localStorage.setItem('websocket_client_id', clientId);
            ws.send(JSON.stringify({ type: 'client_id_ack', id: clientId }));
            logOutgoingMessage({ type: 'client_id_ack', id: clientId });
            return;
        }

        if (data.type === 'ping') {
            ws.send(JSON.stringify({ type: 'pong' }));
            logOutgoingMessage({ type: 'pong' });
            return;
        }
        
        if (data.type === 'timestamp') {
            const timestamp = parseInt(data.timestamp);
            const timeStr = new Date(timestamp).toLocaleTimeString();
            clockDiv.textContent = timeStr;
        }
    } catch (error) {
        console.error('Error processing message:', error, event.data);
        const errorDiv = document.createElement('div');
        errorDiv.className = 'text-red-500';
        errorDiv.textContent = `[${new Date().toLocaleTimeString()}] ❌ Error: ${error.message}`;
        messagesDiv.appendChild(errorDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
};

function logOutgoingMessage(data) {
    const messageDiv = document.createElement('div');
    messageDiv.className = 'text-blue-500';
    messageDiv.textContent = `[${new Date().toLocaleTimeString()}] ⬆️ Sent: ${JSON.stringify(data)}`;
    messagesDiv.appendChild(messageDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

                ws.onclose = (event) => {
                    console.log('WebSocket closed:', event.code, event.reason);
                    statusDiv.textContent = 'Disconnected - Reconnecting...';
                    statusDiv.className = 'inline-block text-sm font-medium rounded-full px-4 py-1 bg-red-100 text-red-800';
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'text-yellow-500';
                    messageDiv.textContent = `[${new Date().toLocaleTimeString()}] 🔌 WebSocket disconnected (${event.code}: ${event.reason || 'No reason provided'})`;
                    messagesDiv.appendChild(messageDiv);
                    ws = null;

                    if (event.code !== 1000) {
                        scheduleReconnect();
                    }
                };

                ws.onerror = (error) => {
                    console.log('WebSocket error:', error);
                };
            } catch (error) {
                console.error('Error creating WebSocket:', error);
                scheduleReconnect();
            }
        }
        
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                cleanupConnection();
            } else {
                if (!ws && !isReconnecting) {
                    connect();
                }
            }
        });

        window.addEventListener('beforeunload', () => {
            cleanupConnection();
        });
        
        connect();
    </script>
</section>
{% endblock %} 