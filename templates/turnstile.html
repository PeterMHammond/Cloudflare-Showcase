{% extends "base.html" %}

{% block content %}
<div class="p-8">
    <h1 class="text-3xl font-bold mb-8">{{ page_title }}</h1>
    
    <div class="max-w-2xl mx-auto">
        <div class="bg-gray-50 p-6 rounded-lg shadow-sm mb-8">
            <h2 class="text-xl font-semibold mb-4">Turnstile Configuration</h2>
            <div class="space-y-2 mb-6 font-mono text-sm bg-gray-100 p-4 rounded">
                <p><span class="font-semibold">Site Key:</span> {{ site_key }}</p>
                <p><span class="font-semibold">Widget Mode:</span> Interactive</p>
                <p><span class="font-semibold">Theme:</span> Light</p>
                <p><span class="font-semibold">Size:</span> Normal</p>
                <p><span class="font-semibold">Action:</span> turnstile/test</p>
            </div>

            <h2 class="text-xl font-semibold mb-4">Test Form</h2>
            <form id="turnstileForm" class="space-y-6" hx-post="/turnstile" hx-swap="none">
                <div id="turnstile-widget"></div>
                
                <div>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition-colors">
                        Server Validate Turnstile
                    </button>
                </div>
            </form>
        </div>

        <div id="result" class="hidden rounded-lg p-4 mb-8">
            <!-- Result will be shown here -->
        </div>

        <div class="bg-gray-50 p-6 rounded-lg shadow-sm">
            <h2 class="text-xl font-semibold mb-4">Response Details</h2>
            <pre id="responseDetails" class="bg-gray-100 p-4 rounded overflow-x-auto text-sm">
                Waiting for validation...
            </pre>
        </div>
    </div>
</div>

<script>
    // Define the onTurnstileLoad callback that the script is looking for
    window.onTurnstileLoad = function() {
        turnstile.render('#turnstile-widget', {
            sitekey: '{{ site_key }}',
            theme: 'light',
            action: 'turnstile/test',
            callback: function(token) {
                console.log('Test Turnstile token:', token);
            }
        });
    };

    document.getElementById('turnstileForm').addEventListener('htmx:afterRequest', function(event) {
        const resultDiv = document.getElementById('result');
        const responseDetails = document.getElementById('responseDetails');
        resultDiv.classList.remove('hidden', 'bg-green-100', 'bg-red-100');
        
        try {
            const response = JSON.parse(event.detail.xhr.response);
            responseDetails.textContent = JSON.stringify(response, null, 2);
            
            if (response.success) {
                resultDiv.classList.add('bg-green-100');
                resultDiv.innerHTML = '<p class="text-green-800">✓ Turnstile validation successful!</p>';
            } else {
                resultDiv.classList.add('bg-red-100');
                resultDiv.innerHTML = '<p class="text-red-800">✗ Turnstile validation failed.</p>';
            }
        } catch (e) {
            resultDiv.classList.add('bg-red-100');
            resultDiv.innerHTML = '<p class="text-red-800">✗ Error processing response.</p>';
            responseDetails.textContent = 'Error parsing response: ' + e.message;
        }
    });
</script>
{% endblock %} 