<script>
  (() => {
    const sessionId = "{{ session_id | default(uuid4()) }}";
    const pageName = "{{ base.title }}";
    const throttle = (fn, delay) => {
      let lastTime = 0;
      return (...args) => {
        const now = Date.now();
        if (now - lastTime >= delay) {
          lastTime = now;
          fn(...args);
        }
      };
    };

    // Send data to analytics endpoint
    const sendAnalytics = async (eventType, data) => {
      try {
        const response = await fetch('/analytics/data', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ session_id: sessionId, event_type: eventType, data })
        });
        return response.ok;
      } catch (e) {
        console.error('Analytics error:', e);
        return false;
      }
    };

    // Calculate scroll percentage
    const getScrollPercentage = () => {
      const windowHeight = window.innerHeight;
      const documentHeight = Math.max(
        document.body.scrollHeight,
        document.documentElement.scrollHeight,
        document.body.offsetHeight,
        document.documentElement.offsetHeight,
        document.body.clientHeight,
        document.documentElement.clientHeight
      );
      
      if (documentHeight <= windowHeight) return 100;
      
      const scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop || 0;
      const scrollableDistance = documentHeight - windowHeight;
      return Math.round((Math.min(scrollTop, scrollableDistance) / scrollableDistance) * 100);
    };

    document.addEventListener('DOMContentLoaded', () => {
      // Track page load time
      setTimeout(() => {
        const loadTime = window.performance.timing.domContentLoadedEventEnd - 
                        window.performance.timing.navigationStart;
        sendAnalytics('page_load', { load_time_ms: loadTime, page: pageName });
      }, 0);

      // Time on page tracking
      let seconds = 0;
      const timeInterval = setInterval(() => {
        seconds++;
        if (seconds % 30 === 0) {
          sendAnalytics('time_on_page', { seconds, page: pageName });
        }
      }, 1000);

      // Interaction tracking
      const interactions = { click: 0, scroll: 0, keypress: 0 };
      let maxScrollPercentage = 0;
      
      // Check initial scroll position
      setTimeout(() => {
        maxScrollPercentage = getScrollPercentage();
        if (maxScrollPercentage > 0) {
          sendAnalytics('page_viewed', { 
            percentage: Math.floor(maxScrollPercentage / 10) * 10, 
            page: pageName 
          });
        }
      }, 1000);
      
      // Handle user interactions
      const reportInteraction = throttle((type) => {
        sendAnalytics('interaction', { 
          type, 
          counts: interactions, 
          page: pageName, 
          max_scroll_percentage: maxScrollPercentage 
        });
      }, 5000);
      
      // Handle scroll tracking
      const reportScroll = throttle(() => {
        const current = getScrollPercentage();
        const oldBracket = Math.floor(maxScrollPercentage / 10) * 10;
        const newBracket = Math.floor(current / 10) * 10;
        
        if (current > maxScrollPercentage) {
          maxScrollPercentage = current;
          if (newBracket > oldBracket) {
            sendAnalytics('page_viewed', { percentage: newBracket, page: pageName });
          }
        }
      }, 2000);
      
      // Set up event listeners
      ['click', 'keypress'].forEach(type => {
        document.addEventListener(type, () => {
          interactions[type]++;
          reportInteraction(type);
        });
      });
      
      document.addEventListener('scroll', () => {
        interactions.scroll++;
        reportScroll();
        reportInteraction('scroll');
      });
      
      // Handle page unload
      window.addEventListener('beforeunload', () => {
        sendAnalytics('time_on_page', { seconds, page: pageName, final: true });
        clearInterval(timeInterval);
      });
    });
  })();
</script>